# 31일차 부터 한주동안 원동식 교수님의 강의
dongshikw@gmail.com

## 자율주행을 위한 데이터 처리 (실습은 코랩에서)
1. 칼만필터와 데이터추적기법
2. 라이다,레이더 데이터 처리, Carla 시뮬레이터
3. 경로계획 알고리즘
4. PID 제어 기법 및 응용
5. CUDA 자율주행 시스템 설계 및 구현

## 선형 칼만 필터란?
1. 개념 :
- 자율주행에서 가장 앞서는 "차량의 위치와 속도"를, 칼만 필터로 노이즈를 피해 정확히 추정한다.
- 센서 데이터의 노이즈 : GPS는 점으로 표현되지만, 실제 경로는 부드러운 곡선이기에 당연히 오차 발생.
- 칼만 필터 : 노이즈가 섞인 측정값들을 지능적으로 결합해 최적의 추정치를 계산하는 알고리즘.
- 단순 평균과 달리, 각 측정값의 신뢰도를 고려하여 가중 평균을 계산한다. (신뢰도가 높은 측정값에 높은 가중치 부여)
- 측정값 = 실제값 + 노이즈 / Y = X + N

<img width="643" height="446" alt="image" src="https://github.com/user-attachments/assets/48c51707-9e49-46fc-9964-1adfe3513f21" /><br>
-> 실제값에 가까운 측정값을 얻도록 가중 평균을 계산하는게 핵심 아이디어.

2. 동작 원리 : 예측과 갱신 두 단계를 무한히 반복함.
- 예측 : 이전 상태를 바탕으로 현재 상태 추측
- 갱신 : 실제 센서 측정값으로 예측값을 보정<br>
ex) 터널 진입 직전의 속도와 방향으로 차량 위치를 계속 추정(예측)하다가,<br>
터널을 빠져나오자마자 잡히는 GPS 신호 측정값으로 오차를 보정한 위치를 표현(갱신)

-> GPS(절대위치)와 IMU(상대 움직임) 데이터를 결합하여 터널, 악천후에서도 정확한 위치를 추정할때 칼만 필터를 쓴다!

3. 핵심 내용 정리
- 칼만 필터는 "노이즈가 많은 센서 데이터"를 결합하여, 실시간으로 최적의 상태(위치, 속도 등)을 추정하는 알고리즘.
- 핵심 아이디어는 각 데이터의 불확실성(신뢰도)를 고려한 지능적인 가중 평균.
- 정밀한 실시간 추정이 필요한 모든 시스템(드론, 자율주행, 로봇)등이 응용 분야이다.
  <img width="590" height="80" alt="image" src="https://github.com/user-attachments/assets/95005ca5-a401-45f9-8d18-e166300f5ef4" />
- 칼만 이득 계산 K = P k−1 / (P k−1 + R)<br>
  <img width="144" height="57" alt="image" src="https://github.com/user-attachments/assets/6fad37c7-ff4a-4606-aaba-31799bff60cf" />
- 칼만 이득값이 작을수록 측정보다 추정(모델)을 더 신뢰, 클수록 측정을 더 신뢰
  
- 갱신된 추정값 = 기존 추정값 + K*(예측 오차)
- (예측 오차) = (측정값 z - 추정값 estimate)
- 오차를 K만큼 반영하여 추정값을 갱신하는것.

## 센서 융합이란?
1. 개념 :
- 하나의 센서만으로는 완벽한 인지가 어렵다. 여러 종류의 센서를 사용하여, 장점은 취하고 단점은 보완하는 기술.
- 센서별 오차 모델, 시간 지연, 상관관계 등을 고려한 복잡한 기법을 실전에서 쓰게될것. 예제는 매우 간단한 케이스.
- GPS : 지구 어디든 모두 동일한 좌표축인 전역 위치를 파악하기에 오차 누적 없음 / 터널같은 공간에서 낮은 수신율 (1~10Hz)
- IMU : 높은 데이터 수신율 (100Hz 이상) / 시간이 지날수록 오차가 누적됨 (drift)
-> 두 센서는 서로의 단점을 완벽히 보완한다.

2. 칼만 필터로 융합하기
- 예측 : 빠른 IMU 센서로, GPS 신호가 없는 순간동안 위치를 예측함.
- 갱신 : 가끔씩 들어오지만 정확한 좌표인 GPS 신호로 갱신하여, IMU 센서의 오차를 지워냄.
-> IMU로 추정하고, GPS로 보정하는 느낌

3. 가중 평균 융합, gps와 imu모두 가중치를 곱하여 합친다.
```python
w_gps = 0.6  # GPS 신뢰도(가중치)
w_imu = 0.4  # IMU 신뢰도(가중치)

fused_positions = [
    w_gps * gps_positions[i] + w_imu * imu_positions[i]
    for i in range(10)
]
```
파이썬의 리스트 컴프리헨션(List Comprehension) 문법으로, 10개짜리 리스트를 생성했다.

상황에 따라 동적으로 가중치 조절이 가능(예: GPS 수신 상태에 따라 w_gps를 낮추기)<br>

<img width="570" height="443" alt="image" src="https://github.com/user-attachments/assets/1990962b-e26c-4167-b9d0-9975472be0e4" /><br>
ex) GPS 가중치를 0.9로 높게 설정하니, GPS값과 거의 유사하게 융합되었다.

## 칼만 필터 실습과 한계
1차원 선형 칼만 필터 코드를 작성해보기. 매우 간단.

<img width="599" height="447" alt="image" src="https://github.com/user-attachments/assets/901930c5-adf9-4234-93a9-4b17bdaf97fc" /><br>
-> 측정값이 가우시안 노이즈가 끼어있는데, 칼만 필터 적용시 이상적인 값인 0에 근접함.

- 근본적인 한계 : 시스템이 선형적이고, 가우시안 분포를 따라야한다는게 조건.
- 이 한계들을 극복한 EKF, UKF 등이 있다.
- (칼만 이득 K 계산 -> 추정값 갱신 -> 추정 오차 P 갱신) 3줄의 반복으로, 추정치는 점점 정확해진다.

**-> 칼만 필터는 불확실성 속에서 최적의 정보를 추출하는 강력한 도구지만, 시스템을 잘 가정해야한다.**
